{"version":3,"sources":["selection-types.js","selection-entry.js","utils.js","selection-observer.js","index.js"],"names":["NON_SELECTION_TAGS","Set","TYPES_TAGS","type","tags","SelectionObserverEntry","selection","range","target","srcTarget","oldTarget","normalize","isCollapsed","startContainer","nodeType","Node","TEXT_NODE","splitText","startOffset","endContainer","endOffset","walker","document","createTreeWalker","NodeFilter","SHOW_ALL","nodes","nextNode","containsNode","currentNode","some","node","contains","push","filter","textContent","trim","value","localName","Object","defineProperty","window","getComputedStyle","display","getBoundingClientRect","find","has","tag","validate","isElement","arg","Element","TypeError","isFunction","findElementNode","parentElement","SELECTION_TARGETS","WeakMap","UNSELECT_HANDLERS","DEFAULT_OBSERVE_OPTIONS","undefined","ignoreMainContainer","onlyElements","SelectionObserver","callback","targets","set","get","unselectHandlers","currentElement","addEventListener","event","length","src","preventDefault","forEach","handler","options","getSelection","collapse","e","removeAllRanges","addRange","Range","focusNode","setTimeout","dispatchEvent","CustomEvent","detail","rangeCount","getRangeAt","commonAncestorContainer","findContainer","entry","assign","recordIndex","findIndex","item","splice"],"mappings":"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","file":"index.js","sourceRoot":"../lib","sourcesContent":["export const NON_SELECTION_TAGS = new Set(['hr', 'img']);\n\nexport const TYPES_TAGS = [\n  {\n    type: 'layer',\n    tags: new Set(['div', 'article', 'main', 'section', 'aside', 'header', 'footer']),\n  },\n  {\n    type: 'title',\n    tags: new Set(['h1', 'h2', 'h3', 'h4', 'h5', 'h6']),\n  },\n  {\n    type: 'list',\n    tags: new Set(['ol', 'ul']),\n  },\n  {\n    type: 'list-item',\n    tags: new Set(['li']),\n  },\n  {\n    type: 'line',\n    tags: new Set(['hr']),\n  },\n  {\n    type: 'image',\n    tags: new Set(['img']),\n  },\n  {\n    type: 'paragraph',\n    tags: new Set(['p']),\n  },\n  {\n    type: 'code',\n    tags: new Set(['code', 'pre']),\n  },\n];\n","import { TYPES_TAGS } from './selection-types';\n\nexport class SelectionObserverEntry {\n  constructor({ selection, range, target, srcTarget, oldTarget }) {\n    this.selection = selection;\n    this.range = range;\n    this.target = target;\n    this.srcTarget = srcTarget;\n    this.oldTarget = oldTarget;\n  }\n\n  get tag() {\n    const value = this.target.localName;\n\n    Object.defineProperty(this, 'tag', { value });\n\n    return value;\n  }\n\n  get display() {\n    const value = window.getComputedStyle(this.target).display;\n\n    Object.defineProperty(this, 'display', { value });\n\n    return value;\n  }\n\n  get rects() {\n    const value = this.target.getBoundingClientRect();\n\n    Object.defineProperty(this, 'rects', { value });\n\n    return value;\n  }\n\n  get type() {\n    const { type: value } = TYPES_TAGS.find(({ tags }) => tags.has(this.tag)) || { type: this.display };\n\n    Object.defineProperty(this, 'type', { value });\n\n    return value;\n  }\n\n  getSelectedNodes() {\n    this.target.normalize();\n\n    if (this.selection.isCollapsed) {\n      return [];\n    }\n\n    if (this.range.startContainer.nodeType === Node.TEXT_NODE) {\n      this.range.startContainer.splitText(this.range.startOffset);\n    }\n\n    if (this.range.endContainer.nodeType === Node.TEXT_NODE) {\n      this.range.endContainer.splitText(this.range.endOffset);\n    }\n\n    const walker = document.createTreeWalker(this.target, NodeFilter.SHOW_ALL);\n    const nodes = [];\n\n    while (walker.nextNode()) {\n      if (!this.selection.containsNode(walker.currentNode)) {\n        continue;\n      }\n\n      if (nodes.some(node => node.contains(walker.currentNode))) {\n        continue;\n      }\n\n      nodes.push(walker.currentNode);\n    }\n\n    return nodes.filter(node => node.textContent.trim());\n  }\n}\n","export const validate = {\n  isElement(value, arg) {\n    if (value instanceof Element) {\n      return;\n    }\n\n    throw new TypeError(`Argument ${arg} must be an Element`);\n  },\n\n  isFunction(value, arg) {\n    if (typeof value === 'function') {\n      return;\n    }\n\n    throw new TypeError(`Argument ${arg} must be a Function`);\n  }\n};\n\nexport const findElementNode = (node, target, filter = () => true) => {\n  if (!node || !target.contains(node)) {\n    return null;\n  }\n\n  if (node.nodeType === Node.TEXT_NODE || !filter(node)) {\n    return findElementNode(node.parentElement, target, filter);\n  }\n\n  return node;\n};\n","import { SelectionObserverEntry } from './selection-entry';\nimport { NON_SELECTION_TAGS } from './selection-types';\nimport { validate, findElementNode } from './utils';\n\nconst SELECTION_TARGETS = new WeakMap();\nconst UNSELECT_HANDLERS = new WeakMap();\n\nconst DEFAULT_OBSERVE_OPTIONS = {\n  filter: undefined,\n  ignoreMainContainer: false,\n  onlyElements: false,\n};\n\nexport class SelectionObserver {\n  constructor(callback) {\n    validate.isFunction(callback);\n\n    const targets = SELECTION_TARGETS.set(this, []).get(this);\n    const unselectHandlers = UNSELECT_HANDLERS.set(this, []).get(this);\n\n    let currentElement = null;\n\n    const onPointerDown = (event) => {\n      if (targets.length === 0) {\n        return;\n      }\n\n      const src = targets.find(({ target }) => target.contains(event.target));\n\n      if (!src) {\n        event.preventDefault();\n\n        currentElement && unselectHandlers.forEach(handler => handler({\n          target: event.target,\n          oldTarget: currentElement\n        }));\n\n        currentElement = null;\n        return;\n      }\n\n      if (src.options.ignoreMainContainer && event.target === src.target) {\n        event.preventDefault();\n        return;\n      }\n\n      if (!NON_SELECTION_TAGS.has(event.target.localName)) {\n        return;\n      }\n\n      event.preventDefault();\n\n      const selection = window.getSelection();\n\n      try {\n        selection.collapse(event.target);\n      } catch (e) {\n        selection.removeAllRanges();\n        selection.addRange(new Range());\n      }\n\n      if (selection.focusNode !== event.target) {\n        setTimeout(() => {\n          document.dispatchEvent(new CustomEvent('selectionchange', { detail: event.target }));\n        });\n      }\n    };\n\n    const onSelectionChange = (event) => {\n      if (targets.length === 0) {\n        return;\n      }\n\n      const selection = window.getSelection();\n\n      if (selection.rangeCount === 0) {\n        return;\n      }\n\n      const range = selection.getRangeAt(0);\n      const src = targets.find(({ target }) => target.contains(event.detail || range.commonAncestorContainer));\n\n      if (!src) {\n        return;\n      }\n\n      let findContainer = event.detail;\n\n      if (!findContainer) {\n        if (range.commonAncestorContainer === src.target && range.endOffset === 0) {\n          findContainer = range.startContainer;\n        } else {\n          findContainer = range.commonAncestorContainer;\n        }\n      }\n\n      const target = findElementNode(findContainer, src.target, src.options.filter);\n\n      if (src.options.onlyElements && target === currentElement) {\n        return;\n      }\n\n      if (!target) {\n        return;\n      }\n\n      const entry = new SelectionObserverEntry({\n        selection,\n        range,\n        target,\n        oldTarget: currentElement,\n        srcTarget: src.target,\n      });\n\n      callback(entry);\n      currentElement = target;\n    };\n\n    document.addEventListener('pointerdown', onPointerDown, false);\n    document.addEventListener('selectionchange', onSelectionChange, false);\n  }\n\n  observe(target, options) {\n    SELECTION_TARGETS.get(this).push({\n      target,\n      options: Object.assign({}, DEFAULT_OBSERVE_OPTIONS, options)\n    });\n  }\n\n  unselectHandler(callback) {\n    UNSELECT_HANDLERS.get(this).push(callback);\n  }\n\n  disconnect(target) {\n    const targets = SELECTION_TARGETS.get(this);\n    const recordIndex = targets.findIndex(item => item.target === target);\n\n    if (~recordIndex) {\n      targets.splice(recordIndex, 1);\n    }\n  }\n}\n","import { SelectionObserver } from './selection-observer';\n\nexport {\n  SelectionObserver\n}\n"]}